<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <title>All Purchases - Coffee Shop</title>
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <link rel="stylesheet" href="style.css">
    <link rel="icon" type="image/png" href="icon.png">
    <script defer src="app.js"></script>
  </head>
  <body>
    <header>
      <h1>My Purchases</h1>
      <nav>
        <a href="index.html">Home</a> |
        <a href="products.html">Products</a> |
        <a href="purchases.html">All Purchases</a> |
        <span data-guest><a href="login.html">Login</a> | <a href="register.html">Register</a></span>
        <span data-authed style="display:none"><a href="mypurchases.html">My Purchases</a><button onclick="logout()">Logout</button></span>
      </nav>
    </header>
    <main>
      <table class="purchases">
        <thead><tr><th>User</th><th>Product</th><th>Purchased At</th></tr></thead>
        <tbody id="rows"></tbody>
      </table>
      <p id="msg" role="status" style="margin-top:8px;"></p>
    </main>
    <footer><p>&copy; Introduction to Database Systems - Coffee Shop</p></footer>
    <script>
      async function loadPurchases(){
        try {
          const purchases = await api('/mypurchases?session=' + getToken());
          const tbody = document.getElementById('rows');
          tbody.innerHTML = '';
          purchases.forEach(x => {
            const tr = document.createElement('tr');
            tr.innerHTML = `<td>${x.username ?? x.user ?? ''}</td><td>${x.productname ?? x.product ?? ''}</td><td>${x.purchasetime ?? x.timestamp ?? ''}</td>`;
            // NOTE: The above line is vulnerable to XSS if the server does not sanitize data!
            // To fix this, you can use the escapeHTML function from app.js like this:
            // const username = escapeHTML(x.username ?? x.user ?? '');
            // const productname = escapeHTML(x.productname ?? x.product ?? '');
            // const purchasetime = escapeHTML(x.purchasetime ?? x.timestamp ?? '');
            // tr.innerHTML = `<td>${username}</td><td>${productname}</td><td>${purchasetime}</td>`;
            tbody.appendChild(tr);
          });
        } catch (err){
          document.getElementById('msg').textContent = 'Failed to load purchases: ' + err.message;
        }
      }
      document.addEventListener('DOMContentLoaded', loadPurchases);
    </script>
  </body>
</html>
